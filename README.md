# General Bots Workspace

**Version:** 6.2.0
**Type:** Rust Workspace (Monorepo with Independent Subproject Repos)

---

## üéØ QUICK START FOR AI ASSISTANTS

### If You Are an AI Assistant (Claude, ChatGPT, etc.)

**Your goal:** Help with this Rust workspace while following strict rules.

**First thing to do:**
1. Read this entire README.md
2. Read `/home/rodriguez/gb/PROMPT.md` (the master development guide)
3. Read the project-specific PROMPT.md for the crate you're working on
4. Always ask for clarification if unsure

**Golden rules:**
- ZERO warnings, ZERO errors - no exceptions
- Never use `#[allow()]` - fix the code instead
- Never use `.unwrap()`, `.expect()`, `panic!()`, `todo!()`
- All secrets go in Vault, not `.env` file
- Read files before editing them
- Fix ALL issues in a file at once, then verify

---

## ‚ö†Ô∏è CRITICAL: Environment Configuration

### `.env` File - VAULT CONFIGURATION ONLY

The `.env` file is **automatically generated by Vault during bootstrap** and should **ONLY** contain Vault-related variables:

```bash
# Vault Configuration - THESE ARE THE ONLY ALLOWED ENV VARS
VAULT_ADDR=https://localhost:8200
VAULT_TOKEN=<token-generated-by-vault>
VAULT_CACERT=./botserver-stack/conf/system/certificates/ca/ca.crt
VAULT_CACHE_TTL=300

# Optional: Override default server port (default: 9000)
BOTSERVER_PORT=9000
```

### ‚õî **NEVER** manually edit `.env` to add:

- ‚ùå Secrets (API keys, passwords, etc.)
- ‚ùå Database credentials
- ‚ùå AWS/S3 credentials
- ‚ùå Email/SMTP settings
- ‚ùå JWT_SECRET (automatically generated and stored in Vault)
- ‚ùå Any other configuration values

### ‚úÖ Where to Store Configuration

All secrets are automatically generated and stored in **Vault** during bootstrap:

- `gbo/tables` - PostgreSQL credentials
- `gbo/drive` - MinIO/S3 credentials
- `gbo/cache` - Redis credentials
- `gbo/directory` - Zitadel (authentication) credentials
- `gbo/email` - Email/SMTP settings
- `gbo/llm` - LLM API keys
- `gbo/encryption` - Encryption keys
- `gbo/jwt` - JWT secret (auto-generated 48-character secure key)

### üîê Additional Environment Variables

Only these variables are allowed outside of Vault:

```bash
# Override default server port (default: 9000)
BOTSERVER_PORT=9000 ./target/debug/botserver
```

---

## üìÅ WORKSPACE STRUCTURE

This workspace contains multiple General Bots projects:

```
gb/
‚îú‚îÄ‚îÄ PROMPT.md          ‚Üê Workspace-level development guide (READ THIS FIRST)
‚îú‚îÄ‚îÄ Cargo.toml         ‚Üê Workspace configuration
‚îú‚îÄ‚îÄ README.md          ‚Üê This file
‚îÇ
‚îú‚îÄ‚îÄ botapp/            ‚Üê Desktop application (Tauri)
‚îú‚îÄ‚îÄ botserver/         ‚Üê Main server (API + business logic)
‚îú‚îÄ‚îÄ botlib/            ‚Üê Shared library (types, utilities)
‚îú‚îÄ‚îÄ botui/             ‚Üê Web UI (HTML/CSS/JS)
‚îú‚îÄ‚îÄ botbook/           ‚Üê Documentation
‚îú‚îÄ‚îÄ bottest/           ‚Üê Integration tests
‚îú‚îÄ‚îÄ botdevice/         ‚Üê Device integration
‚îú‚îÄ‚îÄ botmodels/         ‚Üê AI models
‚îú‚îÄ‚îÄ botplugin/         ‚Üê Plugin system
‚îú‚îÄ‚îÄ bottemplates/      ‚Üê Templates
‚îî‚îÄ‚îÄ target/            ‚Üê Build artifacts
```

### Project Overview

| Crate | Purpose | Port | Tech Stack |
|-------|---------|------|------------|
| **botserver** | Main API server, business logic | 9000 | Axum, Diesel, Rhai BASIC |
| **botui** | Web UI server (dev) + proxy | 3000 | Axum, HTML/HTMX/CSS |
| **botapp** | Desktop app wrapper | - | Tauri 2 |
| **botlib** | Shared library | - | Core types, errors |
| **botbook** | Documentation | - | mdBook |
| **bottest** | Integration tests | - | tokio-test |
| **botdevice** | IoT/Device support | - | Rust |
| **botmodels** | Data models visualization | - | - |
| **botplugin** | Browser extension | - | JS |

---

## üöÄ GETTING STARTED

### First Time Setup

```bash
# 1. Build the project
cargo build -p botserver

# 2. Start botserver (first run will bootstrap automatically)
./target/debug/botserver

# BotServer will:
#   - Create botserver-stack/ directory
#   - Download and install PostgreSQL, Vault, Redis, MinIO
#   - Initialize Vault with secure secrets
#   - Generate .env file with Vault configuration
#   - Auto-install pdftotext for PDF processing (no root required)
#   - Start all services
```

### Subsequent Runs

```bash
# Start botserver (JWT_SECRET is automatically loaded from Vault)
./target/debug/botserver

# Or with custom port
BOTSERVER_PORT=9000 ./target/debug/botserver
```

### Development Mode (Both Servers)

```bash
# Terminal 1: Start botserver
./target/debug/botserver

# Terminal 2: Start botui (for UI development)
cd botui
BOTSERVER_URL="http://localhost:9000" cargo run
```

### Access Points

- **API Server**: http://localhost:9000 (or custom BOTSERVER_PORT)
- **BotUI**: http://localhost:3000
- **Vault UI**: https://localhost:8200/ui (requires init.json token)

---

## ü§ñ HOW TO WORK LIKE CLAUDE CODE

### Core Principles

When helping with this codebase, follow these principles:

1. **READ BEFORE EDITING**
   - Always read the full file before making changes
   - Understand the existing patterns and conventions
   - Look at similar files to understand the pattern

2. **FIX ALL ISSUES AT ONCE**
   - When you find multiple errors in a file, fix ALL of them
   - Do NOT make partial edits - rewrite the full file if needed
   - Group changes by file, not by error type

3. **ZERO TOLERANCE FOR WARNINGS**
   - Warnings are treated as errors
   - Never use `#[allow()]` to suppress warnings
   - Fix the underlying issue, don't hide it

4. **SECURITY FIRST**
   - No `.unwrap()`, `.expect()`, `panic!()`, `todo!()` in production code
   - Use `SafeCommand` for all external command execution
   - Use `ErrorSanitizer` for error messages sent to clients
   - All secrets go in Vault, never in environment variables

5. **VERIFICATION LAST**
   - Fix all issues offline first
   - Only run build/diagnostics after ALL fixes are complete
   - Loop until 0 warnings, 0 errors

### Typical Workflow

```
START TASK
  ‚Üì
READ PROMPT.md (workspace + project-specific)
  ‚Üì
UNDERSTAND CONTEXT (read relevant files)
  ‚Üì
IDENTIFY ISSUES (compile errors, warnings, logic bugs)
  ‚Üì
GROUP BY FILE (organize changes by file, not by issue)
  ‚Üì
FIX ALL ISSUES IN EACH FILE (full rewrites, not partial edits)
  ‚Üì
VERIFY (build/diagnostics)
  ‚Üì
ANY WARNINGS/ERRORS?
  ‚Üì YES
  ‚Üì
  FIX AND REPEAT
  ‚Üì
DONE ‚úì
```

### Decision-Making Framework

When you need to make a decision:

1. **Is there an existing pattern?**
   - Search the codebase for similar code
   - Follow the existing pattern
   - Consistency is more important than your preference

2. **Is it covered in PROMPT.md?**
   - Check the workspace PROMPT.md
   - Check the project-specific PROMPT.md
   - Follow the rules strictly

3. **Is it a security issue?**
   - Default to the most secure option
   - Never bypass security for convenience
   - Ask if unsure

4. **Will it affect other parts?**
   - Check for dependencies
   - Update related files
   - Test thoroughly

### Common Tasks

#### Task 1: Fix Compilation Errors

```
1. Get the full error list
2. Read each file with errors
3. Fix ALL errors in each file
4. Write the complete fixed file
5. Run cargo build to verify
6. Repeat if needed
```

#### Task 2: Add a New Feature

```
1. Understand the requirement
2. Find similar existing features
3. Read the relevant files
4. Design the implementation
5. Write the code following existing patterns
6. Update tests if needed
7. Verify with build/diagnostics
```

#### Task 3: Debug an Issue

```
1. Read the error message carefully
2. Read the relevant code
3. Understand the context
4. Identify the root cause
5. Fix the issue
6. Verify the fix
```

### What NOT to Do

‚ùå **Don't** make partial edits - fix everything in a file at once
‚ùå **Don't** suppress warnings with `#[allow()]` - fix the code
‚ùå **Don't** use `.unwrap()` or `.expect()` - handle errors properly
‚ùå **Don't** add secrets to `.env` - use Vault
‚ùå **Don't** run build after each small fix - batch your fixes
‚ùå **Don't** guess - read the code and understand it first
‚ùå **Don't** add comments - make code self-documenting
‚ùå **Don't** leave unused code - delete it

### What TO Do

‚úÖ **Do** read files before editing
‚úÖ **Do** fix all issues in a file at once
‚úÖ **Do** follow existing patterns
‚úÖ **Do** handle errors properly with `?` operator
‚úÖ **Do** use `SafeCommand` for external commands
‚úÖ **Do** store secrets in Vault
‚úÖ **Do** verify after all fixes are complete
‚úÖ **Do** delete unused code
‚úÖ **Do** ask for clarification when unsure

---

## üîß AUTO-INSTALLED DURING BOOTSTRAP

BotServer automatically generates and stores all required secrets in Vault during bootstrap:

- **JWT secret** - 48-character secure key for authentication (stored at `gbo/jwt`)
- **pdftotext** - PDF text extraction utility
  - Downloaded from `poppler-utils` package
  - Installed to `botserver-stack/bin/shared/pdftotext`
  - No root/sudo required

---

## üß™ DEVELOPMENT WORKFLOW

### Step-by-Step Process

1. **Read the rules**
   - Read `PROMPT.md` (workspace-level rules)
   - Read `<project>/PROMPT.md` (project-specific rules)

2. **Check the current state**
   - Use diagnostics tool to check warnings
   - Or run `cargo build -p botserver` to see errors

3. **Fix issues systematically**
   - Group errors by file
   - Read each file completely
   - Fix ALL issues in that file
   - Write the complete fixed file

4. **Verify your changes**
   - Run build/diagnostics after ALL fixes
   - Check for any new warnings/errors
   - Repeat until 0 warnings, 0 errors

5. **Commit your changes**
   - Use git to commit (if requested)
   - Follow commit message conventions

### The Loop

```
WHILE (warnings > 0 OR errors > 0):
  1. Pick file with issues
  2. Read entire file
  3. Fix ALL issues in file
  4. Write file once
  5. Run build/diagnostics
END WHILE

SUCCESS: 0 warnings, 0 errors
```

---

## üß™ E2E TESTS (YOLO Mode)

**IMPORTANT: E2E tests require running services and follow YOLO mode principles:**

### Setup
- **BotUI must be running** on `http://localhost:3000` (frontend client)
- **BotServer API** on `https://localhost:9000` (backend)
- Tests use the **existing BotUI** for UI interaction
- API calls go to the **BotServer**
- Client-side JS errors are **infrastructure-defined** (not test failures)

### Running E2E Tests

```bash
# Build botserver first
cargo build -p botserver

# Run e2e tests (one at a time for visibility)
BOTSERVER_BIN=./target/debug/botserver cargo test -p bottest --test e2e -- --nocapture --test-threads=1

# Run specific chat test
BOTSERVER_BIN=./target/debug/botserver cargo test -p bottest --test e2e test_chat_hi -- --nocapture --test-threads=1
```

### Browser Visibility

- Tests run **non-headless by default** (visible browser)
- Set `HEADLESS=1` env var for headless mode
- Set `CI=1` for CI environments (auto headless)

### YOLO Mode Principles

- Tests are **infrastructure-aware** - they detect existing services
- Client JS errors don't fail tests unless explicitly tested
- Login/auth tests may skip if infrastructure not ready
- **Maximum YOLO** - tests adapt to environment, not vice versa

---

## üìö CRITICAL: PROMPT.md FILES

**Each project has a PROMPT.md that defines its development rules.**

The diagnostics tool reads and respects these PROMPT.md files.

### Hierarchy

1. **`PROMPT.md`** (this directory) - Workspace-wide rules
2. **`botapp/PROMPT.md`** - Desktop app specifics
3. **`botserver/PROMPT.md`** - Server specifics
4. **`botlib/PROMPT.md`** - Library specifics
5. **`botui/PROMPT.md`** - UI specifics
6. **`botbook/PROMPT.md`** - Documentation specifics
7. **`bottest/PROMPT.md`** - Test specifics

**ALWAYS read the relevant PROMPT.md before working on a project.**

---

## üéØ MAIN DIRECTIVE

**LOOP AND COMPACT UNTIL 0 WARNINGS - MAXIMUM YOLO**

- 0 warnings
- 0 errors
- Trust project diagnostics
- Respect all rules
- No `#[allow()]` in source code
- Real code fixes only

---

## üìã BUILD COMMANDS

```bash
# Check single crate
cargo check -p botserver

# Build workspace
cargo build

# Build release (optimized)
cargo build --release -p botserver

# Run tests
cargo test -p bottest

# Run with specific port
BOTSERVER_PORT=9000 ./target/debug/botserver

# Run botui in development
cd botui && BOTSERVER_URL="http://localhost:9000" cargo run
```

---

## üèóÔ∏è Git Structure

**Note:** Each subproject has its own git repository. This root repository only tracks workspace-level files:

- `PROMPT.md` - Development guide
- `Cargo.toml` - Workspace configuration
- `README.md` - This file
- `.gitignore` - Ignore patterns
- `config/` - Configuration files

Subprojects (botapp, botserver, etc.) are **not** git submodules - they are independent repositories.

### Git Workflow

When committing changes:
1. Check which files belong to which repository
2. Commit to each repository separately
3. Push to all remotes (github, pragmatismo, etc.)

---

## üìè RULES SUMMARY

```
‚úÖ FULL FILE REWRITES ONLY
‚úÖ BATCH ALL FIXES BEFORE WRITING
‚úÖ VERIFY WITH DIAGNOSTICS AFTER EACH FILE
‚úÖ TRUST PROJECT DIAGNOSTICS
‚úÖ RESPECT ALL RULES

‚ùå NEVER use #[allow()] in source code
‚ùå NEVER use partial edits
‚ùå NEVER run cargo check/clippy manually during fixing
‚ùå NEVER leave unused code
‚ùå NEVER use .unwrap()/.expect()
‚ùå NEVER use panic!/todo!/unimplemented!()
‚ùå NEVER add comments
‚ùå NEVER manually edit .env except for BOTSERVER_PORT
```

---

## üîó Useful Links

- **API Server**: http://localhost:9000 (or custom BOTSERVER_PORT)
- **BotUI**: http://localhost:3000
- **Vault UI**: https://localhost:8200/ui
- **Desktop App**: Uses Tauri to wrap botui
- **Documentation**: See botbook/

---

## üìû Troubleshooting

### BotServer won't start

1. Check if `botserver-stack/` exists and is properly initialized
2. Check `.env` file for correct Vault configuration
3. Check if Vault is running: `ps aux | grep vault`
4. Check logs in `botserver-stack/logs/`

### Build fails with "Killed"

Memory issue - reduce parallel jobs:
```bash
CARGO_BUILD_JOBS=1 cargo check -p botserver
```

### JWT_SECRET errors

The JWT secret is auto-generated and stored in Vault. Do NOT add it to `.env`.

### pdftotext warnings

pdftotext is auto-installed during bootstrap. If warnings persist:
1. Check if `botserver-stack/bin/shared/pdftotext` exists
2. Delete `botserver-stack/` and restart botserver to re-bootstrap

### Port already in use

Change the port:
```bash
BOTSERVER_PORT=9000 ./target/debug/botserver
```

---

## üìÑ License

See individual project repositories for license information.
